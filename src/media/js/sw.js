// todo: add this to commonplace's `sw.js` blacklist.

importScripts('lib/serviceworker-cache-polyfill.js');

var CACHE_NAME = 'fireplace';
var CACHE_VERSION = 1;
var CACHE_KEY = CACHE_NAME + '-v' + CACHE_VERSION;

self.oninstall = function(event) {
  event.waitUntil(
    caches.open(CACHE_KEY).then(function(cache) {
      // todo: filter by region and language.
      return cache.addAll([
        './app-icons',
        './app-icons/120.png',
        './app-icons/128.png',
        './app-icons/60.png',
        './app-icons/90.png',
        './app.html',
        './manifest.webapp',
        './media',
        './media/css',
        './media/css/fxa.css',
        './media/css/include.css',
        './media/css/splash.css',
        './media/img',
        './media/img/app-icons',
        './media/img/app-icons/120.png',
        './media/img/app-icons/128.png',
        './media/img/app-icons/60.png',
        './media/img/app-icons/90.png',
        './media/img/btn_spinner.png',
        './media/img/btn_spinner_18.png',
        './media/img/btn_spinner_18_2x.png',
        './media/img/btn_spinner_2x.png',
        './media/img/btn_spinner_alt.png',
        './media/img/btn_spinner_alt_2x.png',
        './media/img/carriers',
        './media/img/carriers/bastacorp-category.png',
        './media/img/carriers/claro.png',
        './media/img/carriers/congstar.png',
        './media/img/carriers/deutsche_telekom.svg',
        './media/img/carriers/movistar.png',
        './media/img/carriers/movistar.svg',
        './media/img/carriers/o2.jpg',
        './media/img/carriers/telenor.svg',
        './media/img/carriers/vivo.png',
        './media/img/grain.png',
        './media/img/icons',
        './media/img/icons/brands',
        './media/img/icons/brands/arts&Entertainment-40px.png',
        './media/img/icons/brands/books-40px.png',
        './media/img/icons/brands/countrySpecific-40px.png',
        './media/img/icons/brands/creativity-40px.png',
        './media/img/icons/brands/education-40px.png',
        './media/img/icons/brands/games-40px.png',
        './media/img/icons/brands/groundbreaking-40px.png',
        './media/img/icons/brands/health&Fitness-40px.png',
        './media/img/icons/brands/hiddenGem-40px.png',
        './media/img/icons/brands/lifestyle-40px.png',
        './media/img/icons/brands/LocalCommunityFavourite-40px.png',
        './media/img/icons/brands/maps&Nav-40px.png',
        './media/img/icons/brands/music-40px.png',
        './media/img/icons/brands/mysteryApp-40px.png',
        './media/img/icons/brands/news&Weather-40px.png',
        './media/img/icons/brands/photos&Video-40px.png',
        './media/img/icons/brands/shopping-40px.png',
        './media/img/icons/brands/social-40px.png',
        './media/img/icons/brands/sports-40px.png',
        './media/img/icons/brands/tools&TimesSavers-40px.png',
        './media/img/icons/brands/travel-40px.png',
        './media/img/icons/brands/work&Business-40px.png',
        './media/img/icons/clear.png',
        './media/img/icons/close.png',
        './media/img/icons/mac-applications.jpg',
        './media/img/icons/new.png',
        './media/img/icons/placeholder.png',
        './media/img/icons/popular.png',
        './media/img/icons/ratings',
        './media/img/icons/ratings/CLASSIND_10.png',
        './media/img/icons/ratings/CLASSIND_12.png',
        './media/img/icons/ratings/CLASSIND_14.png',
        './media/img/icons/ratings/CLASSIND_16.png',
        './media/img/icons/ratings/CLASSIND_18.png',
        './media/img/icons/ratings/CLASSIND_L.png',
        './media/img/icons/ratings/descriptors',
        './media/img/icons/ratings/descriptors/pegi_discrimination.png',
        './media/img/icons/ratings/descriptors/pegi_drugs.png',
        './media/img/icons/ratings/descriptors/pegi_fear.png',
        './media/img/icons/ratings/descriptors/pegi_gambling.png',
        './media/img/icons/ratings/descriptors/pegi_inapp_purchase_option.png',
        './media/img/icons/ratings/descriptors/pegi_language.png',
        './media/img/icons/ratings/descriptors/pegi_location_data_sharing.png',
        './media/img/icons/ratings/descriptors/pegi_nudity.png',
        './media/img/icons/ratings/descriptors/pegi_online.png',
        './media/img/icons/ratings/descriptors/pegi_personal_data_sharing.png',
        './media/img/icons/ratings/descriptors/pegi_sex.png',
        './media/img/icons/ratings/descriptors/pegi_social_interaction_functionality.png',
        './media/img/icons/ratings/descriptors/pegi_violence.png',
        './media/img/icons/ratings/ESRB_ao.png',
        './media/img/icons/ratings/esrb_ao_spa.png',
        './media/img/icons/ratings/ESRB_e.png',
        './media/img/icons/ratings/ESRB_e10.png',
        './media/img/icons/ratings/esrb_e10_spa.png',
        './media/img/icons/ratings/esrb_e_spa.png',
        './media/img/icons/ratings/ESRB_m.png',
        './media/img/icons/ratings/esrb_m_spa.png',
        './media/img/icons/ratings/ESRB_t.png',
        './media/img/icons/ratings/esrb_t_spa.png',
        './media/img/icons/ratings/generic_12.png',
        './media/img/icons/ratings/generic_16.png',
        './media/img/icons/ratings/generic_18.png',
        './media/img/icons/ratings/generic_3.png',
        './media/img/icons/ratings/generic_7.png',
        './media/img/icons/ratings/generic_rp.png',
        './media/img/icons/ratings/interactives',
        './media/img/icons/ratings/interactives/ESRB_digital-purchases.png',
        './media/img/icons/ratings/interactives/ESRB_shares-info.png',
        './media/img/icons/ratings/interactives/ESRB_shares-info_small.png',
        './media/img/icons/ratings/interactives/ESRB_shares-location.png',
        './media/img/icons/ratings/interactives/ESRB_shares-location_small.png',
        './media/img/icons/ratings/interactives/ESRB_users-interact.png',
        './media/img/icons/ratings/interactives/ESRB_users-interact_small.png',
        './media/img/icons/ratings/pegi_12.png',
        './media/img/icons/ratings/pegi_16.png',
        './media/img/icons/ratings/pegi_18.png',
        './media/img/icons/ratings/pegi_3.png',
        './media/img/icons/ratings/pegi_7.png',
        './media/img/icons/ratings/USK_0.png',
        './media/img/icons/ratings/USK_12.png',
        './media/img/icons/ratings/USK_16.png',
        './media/img/icons/ratings/USK_18.png',
        './media/img/icons/ratings/USK_6.png',
        './media/img/icons/ratings/USK_RR.png',
        './media/img/icons/regions',
        './media/img/icons/regions/ad.png',
        './media/img/icons/regions/ae.png',
        './media/img/icons/regions/af.png',
        './media/img/icons/regions/ag.png',
        './media/img/icons/regions/ai.png',
        './media/img/icons/regions/am.png',
        './media/img/icons/regions/an.png',
        './media/img/icons/regions/ao.png',
        './media/img/icons/regions/aq.png',
        './media/img/icons/regions/ar.png',
        './media/img/icons/regions/as.png',
        './media/img/icons/regions/at.png',
        './media/img/icons/regions/au.png',
        './media/img/icons/regions/aw.png',
        './media/img/icons/regions/ax.png',
        './media/img/icons/regions/az.png',
        './media/img/icons/regions/ba.png',
        './media/img/icons/regions/bb.png',
        './media/img/icons/regions/bd.png',
        './media/img/icons/regions/be.png',
        './media/img/icons/regions/bf.png',
        './media/img/icons/regions/bg.png',
        './media/img/icons/regions/bh.png',
        './media/img/icons/regions/bi.png',
        './media/img/icons/regions/bj.png',
        './media/img/icons/regions/bm.png',
        './media/img/icons/regions/bn.png',
        './media/img/icons/regions/bo.png',
        './media/img/icons/regions/br.png',
        './media/img/icons/regions/bs.png',
        './media/img/icons/regions/bt.png',
        './media/img/icons/regions/bv.png',
        './media/img/icons/regions/bw.png',
        './media/img/icons/regions/by.png',
        './media/img/icons/regions/bz.png',
        './media/img/icons/regions/ca.png',
        './media/img/icons/regions/cc.png',
        './media/img/icons/regions/cd.png',
        './media/img/icons/regions/cf.png',
        './media/img/icons/regions/cg.png',
        './media/img/icons/regions/ch.png',
        './media/img/icons/regions/ci.png',
        './media/img/icons/regions/ck.png',
        './media/img/icons/regions/cl.png',
        './media/img/icons/regions/cm.png',
        './media/img/icons/regions/cn.png',
        './media/img/icons/regions/co.png',
        './media/img/icons/regions/cr.png',
        './media/img/icons/regions/cs.png',
        './media/img/icons/regions/cu.png',
        './media/img/icons/regions/cv.png',
        './media/img/icons/regions/cx.png',
        './media/img/icons/regions/cy.png',
        './media/img/icons/regions/cz.png',
        './media/img/icons/regions/de.png',
        './media/img/icons/regions/dj.png',
        './media/img/icons/regions/dk.png',
        './media/img/icons/regions/dm.png',
        './media/img/icons/regions/do.png',
        './media/img/icons/regions/dr.png',
        './media/img/icons/regions/dz.png',
        './media/img/icons/regions/ec.png',
        './media/img/icons/regions/ee.png',
        './media/img/icons/regions/eg.png',
        './media/img/icons/regions/eh.png',
        './media/img/icons/regions/er.png',
        './media/img/icons/regions/es.png',
        './media/img/icons/regions/et.png',
        './media/img/icons/regions/eu.png',
        './media/img/icons/regions/fi.png',
        './media/img/icons/regions/fj.png',
        './media/img/icons/regions/fk.png',
        './media/img/icons/regions/fm.png',
        './media/img/icons/regions/fo.png',
        './media/img/icons/regions/fr.png',
        './media/img/icons/regions/fx.png',
        './media/img/icons/regions/ga.png',
        './media/img/icons/regions/gb.png',
        './media/img/icons/regions/gd.png',
        './media/img/icons/regions/ge.png',
        './media/img/icons/regions/gf.png',
        './media/img/icons/regions/gg.png',
        './media/img/icons/regions/gh.png',
        './media/img/icons/regions/gi.png',
        './media/img/icons/regions/gl.png',
        './media/img/icons/regions/gm.png',
        './media/img/icons/regions/gn.png',
        './media/img/icons/regions/gp.png',
        './media/img/icons/regions/gq.png',
        './media/img/icons/regions/gr.png',
        './media/img/icons/regions/gs.png',
        './media/img/icons/regions/gt.png',
        './media/img/icons/regions/gu.png',
        './media/img/icons/regions/gw.png',
        './media/img/icons/regions/gy.png',
        './media/img/icons/regions/hk.png',
        './media/img/icons/regions/hm.png',
        './media/img/icons/regions/hn.png',
        './media/img/icons/regions/hr.png',
        './media/img/icons/regions/ht.png',
        './media/img/icons/regions/hu.png',
        './media/img/icons/regions/id.png',
        './media/img/icons/regions/ie.png',
        './media/img/icons/regions/il.png',
        './media/img/icons/regions/im.png',
        './media/img/icons/regions/in.png',
        './media/img/icons/regions/io.png',
        './media/img/icons/regions/iq.png',
        './media/img/icons/regions/ir.png',
        './media/img/icons/regions/is.png',
        './media/img/icons/regions/it.png',
        './media/img/icons/regions/je.png',
        './media/img/icons/regions/jm.png',
        './media/img/icons/regions/jo.png',
        './media/img/icons/regions/jp.png',
        './media/img/icons/regions/ke.png',
        './media/img/icons/regions/kg.png',
        './media/img/icons/regions/kh.png',
        './media/img/icons/regions/ki.png',
        './media/img/icons/regions/km.png',
        './media/img/icons/regions/kn.png',
        './media/img/icons/regions/ko.png',
        './media/img/icons/regions/kp.png',
        './media/img/icons/regions/kw.png',
        './media/img/icons/regions/ky.png',
        './media/img/icons/regions/kz.png',
        './media/img/icons/regions/la.png',
        './media/img/icons/regions/lb.png',
        './media/img/icons/regions/lc.png',
        './media/img/icons/regions/li.png',
        './media/img/icons/regions/lk.png',
        './media/img/icons/regions/lr.png',
        './media/img/icons/regions/ls.png',
        './media/img/icons/regions/lt.png',
        './media/img/icons/regions/lu.png',
        './media/img/icons/regions/lv.png',
        './media/img/icons/regions/ly.png',
        './media/img/icons/regions/ma.png',
        './media/img/icons/regions/mc.png',
        './media/img/icons/regions/md.png',
        './media/img/icons/regions/me.png',
        './media/img/icons/regions/mg.png',
        './media/img/icons/regions/mh.png',
        './media/img/icons/regions/mk.png',
        './media/img/icons/regions/ml.png',
        './media/img/icons/regions/mm.png',
        './media/img/icons/regions/mn.png',
        './media/img/icons/regions/mo.png',
        './media/img/icons/regions/mp.png',
        './media/img/icons/regions/mq.png',
        './media/img/icons/regions/mr.png',
        './media/img/icons/regions/ms.png',
        './media/img/icons/regions/mt.png',
        './media/img/icons/regions/mu.png',
        './media/img/icons/regions/mv.png',
        './media/img/icons/regions/mw.png',
        './media/img/icons/regions/mx.png',
        './media/img/icons/regions/my.png',
        './media/img/icons/regions/mz.png',
        './media/img/icons/regions/na.png',
        './media/img/icons/regions/nc.png',
        './media/img/icons/regions/ne.png',
        './media/img/icons/regions/nf.png',
        './media/img/icons/regions/ng.png',
        './media/img/icons/regions/ni.png',
        './media/img/icons/regions/nl.png',
        './media/img/icons/regions/no.png',
        './media/img/icons/regions/np.png',
        './media/img/icons/regions/nr.png',
        './media/img/icons/regions/nu.png',
        './media/img/icons/regions/nz.png',
        './media/img/icons/regions/om.png',
        './media/img/icons/regions/pa.png',
        './media/img/icons/regions/pe.png',
        './media/img/icons/regions/pf.png',
        './media/img/icons/regions/pg.png',
        './media/img/icons/regions/ph.png',
        './media/img/icons/regions/pk.png',
        './media/img/icons/regions/pl.png',
        './media/img/icons/regions/pm.png',
        './media/img/icons/regions/pn.png',
        './media/img/icons/regions/pr.png',
        './media/img/icons/regions/ps.png',
        './media/img/icons/regions/pt.png',
        './media/img/icons/regions/pw.png',
        './media/img/icons/regions/py.png',
        './media/img/icons/regions/qa.png',
        './media/img/icons/regions/re.png',
        './media/img/icons/regions/restofworld.png',
        './media/img/icons/regions/ro.png',
        './media/img/icons/regions/rs.png',
        './media/img/icons/regions/ru.png',
        './media/img/icons/regions/rw.png',
        './media/img/icons/regions/sa.png',
        './media/img/icons/regions/sb.png',
        './media/img/icons/regions/sc.png',
        './media/img/icons/regions/sd.png',
        './media/img/icons/regions/se.png',
        './media/img/icons/regions/sg.png',
        './media/img/icons/regions/sh.png',
        './media/img/icons/regions/si.png',
        './media/img/icons/regions/sj.png',
        './media/img/icons/regions/sk.png',
        './media/img/icons/regions/sl.png',
        './media/img/icons/regions/sm.png',
        './media/img/icons/regions/sn.png',
        './media/img/icons/regions/so.png',
        './media/img/icons/regions/sq.png',
        './media/img/icons/regions/sr.png',
        './media/img/icons/regions/st.png',
        './media/img/icons/regions/su.png',
        './media/img/icons/regions/sv.png',
        './media/img/icons/regions/sy.png',
        './media/img/icons/regions/sz.png',
        './media/img/icons/regions/tc.png',
        './media/img/icons/regions/td.png',
        './media/img/icons/regions/tf.png',
        './media/img/icons/regions/tg.png',
        './media/img/icons/regions/th.png',
        './media/img/icons/regions/tj.png',
        './media/img/icons/regions/tk.png',
        './media/img/icons/regions/tl.png',
        './media/img/icons/regions/tm.png',
        './media/img/icons/regions/tn.png',
        './media/img/icons/regions/to.png',
        './media/img/icons/regions/tr.png',
        './media/img/icons/regions/tt.png',
        './media/img/icons/regions/tv.png',
        './media/img/icons/regions/tw.png',
        './media/img/icons/regions/tz.png',
        './media/img/icons/regions/ua.png',
        './media/img/icons/regions/ug.png',
        './media/img/icons/regions/uk.png',
        './media/img/icons/regions/us.png',
        './media/img/icons/regions/uy.png',
        './media/img/icons/regions/uz.png',
        './media/img/icons/regions/va.png',
        './media/img/icons/regions/vc.png',
        './media/img/icons/regions/ve.png',
        './media/img/icons/regions/vg.png',
        './media/img/icons/regions/vi.png',
        './media/img/icons/regions/vn.png',
        './media/img/icons/regions/vu.png',
        './media/img/icons/regions/wf.png',
        './media/img/icons/regions/ws.png',
        './media/img/icons/regions/ye.png',
        './media/img/icons/regions/yt.png',
        './media/img/icons/regions/yu.png',
        './media/img/icons/regions/za.png',
        './media/img/icons/regions/zm.png',
        './media/img/icons/regions/zr.png',
        './media/img/icons/regions/zw.png',
        './media/img/icons/slider_arrow-2x.png',
        './media/img/icons/slider_arrow.png',
        './media/img/icons/win-start.png',
        './media/img/logos',
        './media/img/logos/128.png',
        './media/img/logos/32.png',
        './media/img/logos/64.png',
        './media/img/logos/firefox-256.png',
        './media/img/logos/firefox-64.png',
        './media/img/logos/footzilla-2x.png',
        './media/img/logos/footzilla.png',
        './media/img/online-status-beacon.gif',
        './media/img/pretty',
        './media/img/pretty/alert.svg',
        './media/img/pretty/back_arrow.svg',
        './media/img/pretty/back_arrow_active.svg',
        './media/img/pretty/cats-sprite.svg',
        './media/img/pretty/close.svg',
        './media/img/pretty/close_active.svg',
        './media/img/pretty/collection_default.png',
        './media/img/pretty/dropdown.svg',
        './media/img/pretty/dropdown_active.svg',
        './media/img/pretty/gear.svg',
        './media/img/pretty/list_view.svg',
        './media/img/pretty/list_view_active.svg',
        './media/img/pretty/marketplace-icon.svg',
        './media/img/pretty/marketplace_logo.png',
        './media/img/pretty/no-connection.svg',
        './media/img/pretty/rocket.png',
        './media/img/pretty/screenshot_view.svg',
        './media/img/pretty/screenshot_view_active.svg',
        './media/img/pretty/search.svg',
        './media/img/pretty/settings_gear.svg',
        './media/img/pretty/settings_gear_active.svg',
        './media/img/pretty/stars_large.svg',
        './media/img/pretty/stars_small.svg',
        './media/img/pretty/stars_small_white.svg',
        './media/img/pretty/tick-white.svg',
        './media/js',
        './media/js/include.js',
        './media/js/l10n.js',
        './media/locales',
        './media/locales/bg.js',
        './media/locales/bn-BD.js',
        './media/locales/ca.js',
        './media/locales/cs.js',
        './media/locales/da.js',
        './media/locales/de.js',
        './media/locales/el.js',
        './media/locales/en-US.js',
        './media/locales/es.js',
        './media/locales/fr.js',
        './media/locales/ga-IE.js',
        './media/locales/hr.js',
        './media/locales/hu.js',
        './media/locales/it.js',
        './media/locales/ja.js',
        './media/locales/ko.js',
        './media/locales/mk.js',
        './media/locales/nb-NO.js',
        './media/locales/nl.js',
        './media/locales/pl.js',
        './media/locales/pt-BR.js',
        './media/locales/ro.js',
        './media/locales/ru.js',
        './media/locales/sk.js',
        './media/locales/sq.js',
        './media/locales/sr-Latn.js',
        './media/locales/sr.js',
        './media/locales/tr.js',
        './media/locales/zh-CN.js',
        './media/locales/zh-TW.js',
      ]);
    })
  );
};

self.onactivate = function(event) {
  caches.keys().then(function(cacheNames) {
    return Promise.all(
      cacheNames.map(function(cacheName) {
        if (cacheName.indexOf(CACHE_NAME) === -1) {
          return;
        }

        if (cacheName !== CACHE_KEY) {
          return caches.delete(cacheName);
        }
      })
    );
  });
};

self.onfetch = function(event) {
  event.respondWith(
    // Check the cache for a hit.
    caches.match(request).then(function(response) {

      // If we have a response return it.
      if (response)
        return response;

      // Otherwise fetch it, store and respond.
      return fetch(request).then(function(response) {

        var responseToCache = response.clone();

        caches.open(CACHE_KEY).then(
          function(cache) {
            cache.put(request, responseToCache).catch(function(err) {
              // Likely we got an opaque response which the polyfill
              // can't deal with, so log out a warning.
              console.warn(requestURL + ': ' + err.message);
            });
          });

        return response;
      });
    })
  );
};
